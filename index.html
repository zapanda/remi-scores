<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Remi Famiglia</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0e0e10;
    --surface: #18181c;
    --surface2: #222228;
    --border: #2e2e38;
    --accent: #f0c040;
    --accent2: #e05c5c;
    --text: #f0efe8;
    --muted: #7a7a8a;
    --ana: #f0c040;
    --cezi: #6ec6f5;
    --bogdan: #a78bfa;
    --mihai: #f97b6b;
    --radius: 12px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-weight: 400;
    min-height: 100vh;
    padding: 0 0 60px 0;
  }

  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 20px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  header h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    letter-spacing: 3px;
    color: var(--accent);
  }

  header span {
    font-size: 0.78rem;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .container {
    max-width: 860px;
    margin: 0 auto;
    padding: 32px 20px;
    display: flex;
    flex-direction: column;
    gap: 32px;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px 24px;
  }

  .card-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.3rem;
    letter-spacing: 2px;
    color: var(--accent);
    margin-bottom: 20px;
  }

  /* RANKINGS */
  .ranking-list { display: flex; flex-direction: column; gap: 10px; }

  .ranking-row {
    flex-wrap: wrap;
    display: flex;
    align-items: center;
    gap: 8px 12px;
    background: var(--surface2);
    border-radius: 10px;
    padding: 14px 18px;
    border-left: 4px solid var(--border);
    transition: transform 0.15s;
  }

  .ranking-row:hover { transform: translateX(3px); }
  .ranking-row.ana    { border-left-color: var(--ana); }
  .ranking-row.cezi   { border-left-color: var(--cezi); }
  .ranking-row.bogdan { border-left-color: var(--bogdan); }
  .ranking-row.mihai  { border-left-color: var(--mihai); }

  .ranking-pos { font-size: 1.4rem; width: 32px; text-align: center; flex-shrink: 0; }

  .ranking-name {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--muted);
    flex: 1;
    min-width: 60px;
  }

  .ranking-score { font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; letter-spacing: 1px; flex-shrink: 0; }
  .ranking-row.ana    .ranking-score { color: var(--ana); }
  .ranking-row.cezi   .ranking-score { color: var(--cezi); }
  .ranking-row.bogdan .ranking-score { color: var(--bogdan); }
  .ranking-row.mihai  .ranking-score { color: var(--mihai); }

  .ranking-diff { font-size: 0.82rem; color: var(--accent2); text-align: right; font-weight: 500; flex-shrink: 0; }

  /* VIBES */
  .vibes-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  @media (min-width: 500px) { .vibes-grid { grid-template-columns: repeat(4, 1fr); } }

  .vibe-card {
    background: var(--surface2);
    border-radius: 10px;
    padding: 16px 14px;
    text-align: center;
    border-top: 3px solid var(--border);
    transition: transform 0.15s;
  }

  .vibe-card:hover { transform: translateY(-2px); }
  .vibe-card.ana    { border-top-color: var(--ana); }
  .vibe-card.cezi   { border-top-color: var(--cezi); }
  .vibe-card.bogdan { border-top-color: var(--bogdan); }
  .vibe-card.mihai  { border-top-color: var(--mihai); }

  .vibe-card.on-fire {
    background: linear-gradient(160deg, #2a1a0a 0%, var(--surface2) 60%);
    border-top-color: #ff7c2a !important;
    box-shadow: 0 0 18px #ff7c2a22;
  }

  .vibe-card.frozen {
    background: linear-gradient(160deg, #0a1a2a 0%, var(--surface2) 60%);
    border-top-color: #6ec6f5 !important;
    box-shadow: 0 0 18px #6ec6f522;
  }

  .vibe-name { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; color: var(--muted); margin-bottom: 10px; }
  .vibe-badge { font-size: 1.8rem; line-height: 1; margin-bottom: 6px; display: block; }
  .vibe-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; margin-bottom: 10px; display: block; min-height: 14px; }
  .vibe-card.on-fire .vibe-label { color: #ff7c2a; }
  .vibe-card.frozen  .vibe-label { color: #6ec6f5; }
  .vibe-avg { font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; letter-spacing: 1px; }
  .vibe-card.ana    .vibe-avg { color: var(--ana); }
  .vibe-card.cezi   .vibe-avg { color: var(--cezi); }
  .vibe-card.bogdan .vibe-avg { color: var(--bogdan); }
  .vibe-card.mihai  .vibe-avg { color: var(--mihai); }
  .vibe-avg-label { font-size: 0.65rem; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-top: 3px; }
  .vibe-streak { margin-top: 8px; font-size: 0.72rem; color: var(--muted); }
  .vibe-streak strong { color: var(--text); }

  /* CHART */
  .chart-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 20px;
  }

  .chart-header .card-title { margin-bottom: 0; }
  .filter-pills { display: flex; gap: 6px; flex-wrap: wrap; }

  .pill {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 999px;
    color: var(--muted);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 1px;
    padding: 5px 14px;
    cursor: pointer;
    transition: all 0.15s;
    text-transform: uppercase;
  }

  .pill:hover { border-color: var(--accent); color: var(--text); }
  .pill.active { background: var(--accent); border-color: var(--accent); color: #0e0e10; }

  .chart-hint { font-size: 0.72rem; color: var(--muted); margin-bottom: 14px; letter-spacing: 0.5px; }
  .chart-wrap { position: relative; height: 320px; }

  /* FORM */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  @media (min-width: 500px) { .form-grid { grid-template-columns: repeat(4, 1fr); } }

  .field label { display: block; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 2px; color: var(--muted); margin-bottom: 7px; }

  .field input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 1.1rem;
    padding: 11px 13px;
    outline: none;
    transition: border-color 0.15s;
    -moz-appearance: textfield;
  }

  .field input::-webkit-outer-spin-button,
  .field input::-webkit-inner-spin-button { -webkit-appearance: none; }

  .field.ana    input:focus { border-color: var(--ana); }
  .field.cezi   input:focus { border-color: var(--cezi); }
  .field.bogdan input:focus { border-color: var(--bogdan); }
  .field.mihai  input:focus { border-color: var(--mihai); }


  /* +/- TOGGLE BUTTON */
  .field-wrap {
    display: flex;
    gap: 6px;
    align-items: stretch;
  }

  .field-wrap input {
    flex: 1;
    min-width: 0;
  }

  .btn-sign {
    flex-shrink: 0;
    width: 38px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--muted);
    font-size: 1.2rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    padding: 0;
    margin-top: 0;
  }

  .btn-sign:hover { border-color: var(--accent2); color: var(--accent2); }
  .btn-sign.negative { background: #e05c5c22; border-color: var(--accent2); color: var(--accent2); }

  /* modal field wrap */
  .modal-field-wrap {
    display: flex;
    gap: 6px;
    align-items: stretch;
  }

  .modal-field-wrap input {
    flex: 1;
    min-width: 0;
  }

  .submit-row { margin-top: 20px; display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }

  button.submit {
    background: var(--accent);
    color: #0e0e10;
    border: none;
    border-radius: 8px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 2px;
    padding: 13px 32px;
    cursor: pointer;
    transition: opacity 0.15s, transform 0.1s;
  }

  button.submit:hover { opacity: 0.88; transform: translateY(-1px); }
  button.submit:active { transform: translateY(0); }
  button.submit:disabled { opacity: 0.4; cursor: not-allowed; }

  .status-msg { font-size: 0.85rem; color: var(--muted); }
  .status-msg.ok  { color: #6fcf97; }
  .status-msg.err { color: var(--accent2); }

  /* HISTORY TABLE */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }

  thead th {
    text-align: left;
    padding: 10px 12px;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--muted);
    border-bottom: 1px solid var(--border);
  }

  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: var(--surface2); }
  tbody td { padding: 11px 12px; color: var(--text); }
  tbody td.pos  { color: #6fcf97; }
  tbody td.neg  { color: var(--accent2); }
  tbody td.zero { color: var(--muted); }

  tr.totals-row td {
    padding: 12px 12px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    letter-spacing: 1px;
    background: var(--surface2);
    border-top: 2px solid var(--border);
    border-bottom: 2px solid var(--border) !important;
  }

  /* EDIT BUTTON */
  .btn-edit {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    cursor: pointer;
    padding: 4px 8px;
    font-size: 0.85rem;
    transition: all 0.15s;
    line-height: 1;
  }

  .btn-edit:hover { border-color: var(--accent); color: var(--accent); }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 200;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px 24px;
    width: 100%;
    max-width: 480px;
    animation: modalIn 0.2s ease;
  }

  @keyframes modalIn {
    from { opacity: 0; transform: translateY(12px) scale(0.98); }
    to   { opacity: 1; transform: none; }
  }

  .modal-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.3rem;
    letter-spacing: 2px;
    color: var(--accent);
    margin-bottom: 6px;
  }

  .modal-subtitle {
    font-size: 0.78rem;
    color: var(--muted);
    margin-bottom: 22px;
    letter-spacing: 0.5px;
  }

  .modal-date-field {
    margin-bottom: 18px;
  }

  .modal-date-field label {
    display: block;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--muted);
    margin-bottom: 7px;
  }

  .modal-date-field input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 1rem;
    padding: 10px 13px;
    outline: none;
    transition: border-color 0.15s;
  }

  .modal-date-field input:focus { border-color: var(--accent); }

  .modal-scores {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 24px;
  }

  .modal-field label {
    display: block;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--muted);
    margin-bottom: 7px;
  }

  .modal-field input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 1.1rem;
    padding: 10px 13px;
    outline: none;
    transition: border-color 0.15s;
    -moz-appearance: textfield;
  }

  .modal-field input::-webkit-outer-spin-button,
  .modal-field input::-webkit-inner-spin-button { -webkit-appearance: none; }

  .modal-field.ana    input:focus { border-color: var(--ana); }
  .modal-field.cezi   input:focus { border-color: var(--cezi); }
  .modal-field.bogdan input:focus { border-color: var(--bogdan); }
  .modal-field.mihai  input:focus { border-color: var(--mihai); }

  .modal-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  .btn-save {
    background: var(--accent);
    color: #0e0e10;
    border: none;
    border-radius: 8px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    letter-spacing: 2px;
    padding: 11px 26px;
    cursor: pointer;
    transition: opacity 0.15s;
  }

  .btn-save:hover { opacity: 0.88; }
  .btn-save:disabled { opacity: 0.4; cursor: not-allowed; }

  .btn-cancel {
    background: none;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--muted);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    padding: 11px 20px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .btn-cancel:hover { border-color: var(--text); color: var(--text); }

  .btn-delete {
    background: none;
    border: 1px solid #e05c5c44;
    border-radius: 8px;
    color: var(--accent2);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    padding: 11px 20px;
    cursor: pointer;
    transition: all 0.15s;
    margin-left: auto;
  }

  .btn-delete:hover { background: #e05c5c18; border-color: var(--accent2); }
  .btn-delete:disabled { opacity: 0.4; cursor: not-allowed; }

  .modal-status { font-size: 0.82rem; color: var(--muted); width: 100%; margin-top: 4px; }
  .modal-status.ok  { color: #6fcf97; }
  .modal-status.err { color: var(--accent2); }

  /* MISC */
  .loading { text-align: center; color: var(--muted); padding: 40px; font-size: 0.9rem; letter-spacing: 1px; }
  .dot-anim::after { content: ''; animation: dots 1.2s infinite; }

  @keyframes dots {
    0%   { content: ''; }
    33%  { content: '.'; }
    66%  { content: '..'; }
    100% { content: '...'; }
  }

  .fade-in { animation: fadeIn 0.4s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
</style>
</head>
<body>

<header>
  <h1>Remi Famiglia</h1>
  <span>Ana ¬∑ Cezi ¬∑ Bogdan ¬∑ Mihai</span>
</header>

<div class="container">

  <div class="card fade-in">
    <div class="card-title">Rankings</div>
    <div id="rankings"><div class="loading dot-anim">Loading</div></div>
  </div>

  <div class="card fade-in">
    <div class="card-title">Vibes üå°Ô∏è</div>
    <div class="vibes-grid" id="vibes"><div class="loading dot-anim">Loading</div></div>
  </div>

  <div class="card fade-in">
    <div class="chart-header">
      <div class="card-title">Score Progression</div>
      <div class="filter-pills">
        <button class="pill" onclick="setFilter(10, this)">Last 10</button>
        <button class="pill active" onclick="setFilter(20, this)">Last 20</button>
        <button class="pill" onclick="setFilter(50, this)">Last 50</button>
        <button class="pill" onclick="setFilter(null, this)">All time</button>
      </div>
    </div>
    <div class="chart-hint">Click a player name in the legend to show or hide their line.</div>
    <div class="chart-wrap"><canvas id="chart"></canvas></div>
  </div>

  <div class="card fade-in">
    <div class="card-title">Add Game Result</div>
    <div class="form-grid">
      <div class="field ana"><label>Ana</label><div class="field-wrap"><input type="text" inputmode="numeric" id="score-Ana" placeholder="0" oninput="syncSignBtn('score-Ana', 'sign-Ana')"><button type="button" class="btn-sign" id="sign-Ana" onclick="toggleSign('score-Ana', 'sign-Ana')">‚àí</button></div></div>
      <div class="field cezi"><label>Cezi</label><div class="field-wrap"><input type="text" inputmode="numeric" id="score-Cezi" placeholder="0" oninput="syncSignBtn('score-Cezi', 'sign-Cezi')"><button type="button" class="btn-sign" id="sign-Cezi" onclick="toggleSign('score-Cezi', 'sign-Cezi')">‚àí</button></div></div>
      <div class="field bogdan"><label>Bogdan</label><div class="field-wrap"><input type="text" inputmode="numeric" id="score-Bogdan" placeholder="0" oninput="syncSignBtn('score-Bogdan', 'sign-Bogdan')"><button type="button" class="btn-sign" id="sign-Bogdan" onclick="toggleSign('score-Bogdan', 'sign-Bogdan')">‚àí</button></div></div>
      <div class="field mihai"><label>Mihai</label><div class="field-wrap"><input type="text" inputmode="numeric" id="score-Mihai" placeholder="0" oninput="syncSignBtn('score-Mihai', 'sign-Mihai')"><button type="button" class="btn-sign" id="sign-Mihai" onclick="toggleSign('score-Mihai', 'sign-Mihai')">‚àí</button></div></div>
    </div>
    <div class="submit-row">
      <button class="submit" id="submit-btn" onclick="submitScore()">Save Game</button>
      <span class="status-msg" id="status"></span>
    </div>
  </div>

  <div class="card fade-in">
    <div class="card-title">Game History</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Date</th>
            <th style="color:var(--ana)">Ana</th>
            <th style="color:var(--cezi)">Cezi</th>
            <th style="color:var(--bogdan)">Bogdan</th>
            <th style="color:var(--mihai)">Mihai</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="history-body">
          <tr><td colspan="7" class="loading dot-anim">Loading</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- EDIT MODAL -->
<div class="modal-overlay" id="modal-overlay" onclick="handleOverlayClick(event)">
  <div class="modal">
    <div class="modal-title">Edit Game</div>
    <div class="modal-subtitle" id="modal-subtitle">Game #</div>

    <div class="modal-date-field">
      <label>Date</label>
      <input type="date" id="modal-date">
    </div>

    <div class="modal-scores">
      <div class="modal-field ana">
        <label style="color:var(--ana)">Ana</label>
        <div class="modal-field-wrap"><input type="text" inputmode="numeric" id="modal-Ana" oninput="syncSignBtn('modal-Ana', 'modal-sign-Ana')" ><button type="button" class="btn-sign" id="modal-sign-Ana" onclick="toggleSign('modal-Ana', 'modal-sign-Ana')">‚àí</button></div>
      </div>
      <div class="modal-field cezi">
        <label style="color:var(--cezi)">Cezi</label>
        <div class="modal-field-wrap"><input type="text" inputmode="numeric" id="modal-Cezi" oninput="syncSignBtn('modal-Cezi', 'modal-sign-Cezi')" ><button type="button" class="btn-sign" id="modal-sign-Cezi" onclick="toggleSign('modal-Cezi', 'modal-sign-Cezi')">‚àí</button></div>
      </div>
      <div class="modal-field bogdan">
        <label style="color:var(--bogdan)">Bogdan</label>
        <div class="modal-field-wrap"><input type="text" inputmode="numeric" id="modal-Bogdan" oninput="syncSignBtn('modal-Bogdan', 'modal-sign-Bogdan')" ><button type="button" class="btn-sign" id="modal-sign-Bogdan" onclick="toggleSign('modal-Bogdan', 'modal-sign-Bogdan')">‚àí</button></div>
      </div>
      <div class="modal-field mihai">
        <label style="color:var(--mihai)">Mihai</label>
        <div class="modal-field-wrap"><input type="text" inputmode="numeric" id="modal-Mihai" oninput="syncSignBtn('modal-Mihai', 'modal-sign-Mihai')" ><button type="button" class="btn-sign" id="modal-sign-Mihai" onclick="toggleSign('modal-Mihai', 'modal-sign-Mihai')">‚àí</button></div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn-save" id="modal-save" onclick="saveEdit()">Save</button>
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-delete" id="modal-delete" onclick="confirmDelete()">Delete game</button>
    </div>
    <div class="modal-status" id="modal-status"></div>
  </div>
</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxjWdg-CRhpW_y-Lf60AbQOR3vG5KVCjqluORpVQVUzFo4KSgmW8U0_qI0ilPZFwNDHQg/exec';
const PLAYERS = ['Ana', 'Cezi', 'Bogdan', 'Mihai'];
const COLORS  = { Ana: '#f0c040', Cezi: '#6ec6f5', Bogdan: '#a78bfa', Mihai: '#f97b6b' };
const STREAK_THRESHOLD = 3;
const THIS_YEAR = new Date().getFullYear();

let allData = [];
let chartInstance = null;
let activeFilter = 20;
let editingRow = null; // { rowIndex, gameNum }

// ‚îÄ‚îÄ‚îÄ DATE HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function parseDate(raw) {
  if (!raw) return null;
  const s = String(raw).trim();
  const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (iso) return new Date(parseInt(iso[1]), parseInt(iso[2]) - 1, parseInt(iso[3]));
  const us = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
  if (us) return new Date(parseInt(us[3]), parseInt(us[1]) - 1, parseInt(us[2]));
  const d = new Date(s);
  if (!isNaN(d)) return new Date(d.getTime() + d.getTimezoneOffset() * 60000);
  return null;
}

const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

function formatDateTable(raw) {
  const d = parseDate(raw);
  if (!d) return '‚Äî';
  const base = `${MONTHS[d.getMonth()]} ${d.getDate()}`;
  return d.getFullYear() === THIS_YEAR ? base : `${base}, ${d.getFullYear()}`;
}

function buildChartLabels(slice) {
  let lastYear = null;
  return slice.map((row, i) => {
    const d = parseDate(row['Date']);
    const year = d ? d.getFullYear() : null;
    const isFirstOfYear = year !== null && year !== lastYear;
    if (year !== null) lastYear = year;
    if (!d) return `Game ${i + 1}`;
    const base = `${MONTHS[d.getMonth()]} ${d.getDate()}`;
    if (isFirstOfYear) return `${base} '${String(d.getFullYear()).slice(2)}`;
    return base;
  });
}

// Convert YYYY-MM-DD string to a value for <input type="date">
function toInputDate(raw) {
  const d = parseDate(raw);
  if (!d) return '';
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${d.getFullYear()}-${mm}-${dd}`;
}

// ‚îÄ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function loadData() {
  try {
    const res = await fetch(SCRIPT_URL + '?action=getScores');
    allData = await res.json();
    renderRankings();
    renderVibes();
    renderChart();
    renderHistory();
  } catch(e) {
    document.getElementById('rankings').innerHTML = '<span style="color:var(--accent2)">Failed to load data. Check your connection.</span>';
  }
}

function getTotal(player) {
  return allData.reduce((sum, row) => {
    const v = parseFloat(row[player]);
    return sum + (isNaN(v) ? 0 : v);
  }, 0);
}

function getScores(player) {
  return allData.map(row => { const v = parseFloat(row[player]); return isNaN(v) ? 0 : v; });
}

function getAverage(player) {
  const scores = getScores(player);
  if (!scores.length) return 0;
  return scores.reduce((a, b) => a + b, 0) / scores.length;
}

function getStreak(player) {
  const scores = getScores(player);
  const avg = getAverage(player);
  if (scores.length < STREAK_THRESHOLD) return { status: 'neutral', streak: 0 };
  let fireStreak = 0, iceStreak = 0;
  for (let i = scores.length - 1; i >= 0; i--) {
    if (scores[i] > avg) { if (iceStreak > 0) break; fireStreak++; }
    else if (scores[i] < avg) { if (fireStreak > 0) break; iceStreak++; }
    else { break; }
  }
  if (fireStreak >= STREAK_THRESHOLD) return { status: 'fire', streak: fireStreak };
  if (iceStreak  >= STREAK_THRESHOLD) return { status: 'ice',  streak: iceStreak };
  return { status: 'neutral', streak: 0 };
}

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function renderRankings() {
  const totals = PLAYERS.map(p => ({ name: p, score: getTotal(p) }));
  totals.sort((a, b) => b.score - a.score);
  const leader = totals[0].score;
  const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£'];
  document.getElementById('rankings').innerHTML = `<div class="ranking-list">${
    totals.map((p, i) => {
      const diff = p.score - leader;
      const diffStr = i === 0 ? '' : `${diff.toLocaleString()} pts`;
      const scoreStr = (p.score > 0 ? '+' : '') + p.score.toLocaleString();
      return `<div class="ranking-row ${p.name.toLowerCase()}">
        <div class="ranking-pos">${medals[i]}</div>
        <div class="ranking-name">${p.name}</div>
        <div class="ranking-score">${scoreStr}</div>
        <div class="ranking-diff">${diffStr}</div>
      </div>`;
    }).join('')
  }</div>`;
}

function renderVibes() {
  document.getElementById('vibes').innerHTML = PLAYERS.map(p => {
    const avg = getAverage(p);
    const { status, streak } = getStreak(p);
    const isFire = status === 'fire', isIce = status === 'ice';
    const cardClass = isFire ? 'on-fire' : isIce ? 'frozen' : '';
    const badge  = isFire ? 'üî•' : isIce ? 'üßä' : 'üòê';
    const label  = isFire ? 'On Fire' : isIce ? 'Frozen' : '';
    const streakTxt = streak >= STREAK_THRESHOLD
      ? `<div class="vibe-streak"><strong>${streak}</strong> games in a row</div>`
      : `<div class="vibe-streak" style="color:transparent">‚Äî</div>`;
    return `<div class="vibe-card ${p.toLowerCase()} ${cardClass}">
      <div class="vibe-name">${p}</div>
      <span class="vibe-badge">${badge}</span>
      <span class="vibe-label">${label}</span>
      <div class="vibe-avg">${(avg > 0 ? '+' : '') + avg.toFixed(1)}</div>
      <div class="vibe-avg-label">avg / game</div>
      ${streakTxt}
    </div>`;
  }).join('');
}

function setFilter(n, btn) {
  activeFilter = n;
  document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  renderChart();
}

function renderChart() {
  const slice = activeFilter === null ? allData : allData.slice(-activeFilter);
  const offsetsBefore = PLAYERS.reduce((acc, p) => {
    const startIdx = activeFilter === null ? 0 : Math.max(0, allData.length - activeFilter);
    let cum = 0;
    for (let i = 0; i < startIdx; i++) { const v = parseFloat(allData[i][p]); cum += isNaN(v) ? 0 : v; }
    acc[p] = cum;
    return acc;
  }, {});

  const labels = buildChartLabels(slice);
  const datasets = PLAYERS.map(p => {
    let cum = offsetsBefore[p];
    return {
      label: p,
      data: slice.map(row => { const v = parseFloat(row[p]); cum += isNaN(v) ? 0 : v; return cum; }),
      borderColor: COLORS[p],
      backgroundColor: COLORS[p] + '15',
      borderWidth: 3,
      pointRadius: 0,
      pointHoverRadius: 6,
      pointHoverBackgroundColor: COLORS[p],
      pointHoverBorderColor: '#0e0e10',
      pointHoverBorderWidth: 2,
      tension: 0.35,
      fill: false,
    };
  });

  const ctx = document.getElementById('chart').getContext('2d');
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          labels: { color: '#f0efe8', font: { family: 'DM Sans', size: 13 }, boxWidth: 14, padding: 20, usePointStyle: true, pointStyle: 'circle' },
          onClick(e, legendItem, legend) {
            const meta = legend.chart.getDatasetMeta(legendItem.datasetIndex);
            meta.hidden = !meta.hidden;
            legend.chart.update();
          }
        },
        tooltip: {
          backgroundColor: '#18181c', borderColor: '#2e2e38', borderWidth: 1,
          titleColor: '#7a7a8a', titleFont: { family: 'DM Sans', size: 11 },
          bodyColor: '#f0efe8', bodyFont: { family: 'DM Sans', size: 13 }, padding: 14,
          callbacks: {
            label(ctx) {
              const val = ctx.parsed.y;
              return `  ${ctx.dataset.label}: ${val >= 0 ? '+' : ''}${val.toLocaleString()}`;
            }
          }
        }
      },
      scales: {
        x: { ticks: { color: '#7a7a8a', font: { size: 11 }, maxRotation: 45, maxTicksLimit: 12 }, grid: { color: '#2e2e38' } },
        y: { ticks: { color: '#7a7a8a', font: { size: 11 } }, grid: { color: '#2e2e38' } }
      }
    }
  });
}

function scoreClass(v) { return v > 0 ? 'pos' : v < 0 ? 'neg' : 'zero'; }

function renderHistory() {
  const tbody = document.getElementById('history-body');
  if (!allData.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="color:var(--muted);padding:20px">No games yet.</td></tr>';
    return;
  }

  const totalsRow = `<tr class="totals-row">
    <td colspan="2" style="color:var(--muted);font-size:0.7rem;letter-spacing:2px;">TOTAL</td>
    ${PLAYERS.map(p => {
      const t = getTotal(p);
      return `<td style="color:${COLORS[p]}">${(t > 0 ? '+' : '') + t.toLocaleString()}</td>`;
    }).join('')}
    <td></td>
  </tr>`;

  const gameRows = [...allData].reverse().map((row, i) => {
    const gameNum = allData.length - i;
    const date = formatDateTable(row['Date']);
    const rowIndex = row['_rowIndex'];
    return `<tr>
      <td style="color:var(--muted)">${gameNum}</td>
      <td>${date}</td>
      ${PLAYERS.map(p => {
        const v = parseFloat(row[p]);
        const display = isNaN(v) ? '‚Äî' : (v > 0 ? '+' + v : v);
        return `<td class="${isNaN(v) ? '' : scoreClass(v)}">${display}</td>`;
      }).join('')}
      <td><button class="btn-edit" onclick="openModal(${rowIndex}, ${gameNum})">‚úèÔ∏è</button></td>
    </tr>`;
  }).join('');

  tbody.innerHTML = totalsRow + gameRows;
}

// ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function openModal(rowIndex, gameNum) {
  // Find the row in allData by _rowIndex
  const row = allData.find(r => r['_rowIndex'] === rowIndex);
  if (!row) return;

  editingRow = { rowIndex, gameNum };

  document.getElementById('modal-subtitle').textContent = `Game #${gameNum} ¬∑ editing scores`;
  document.getElementById('modal-date').value = toInputDate(row['Date']);
  PLAYERS.forEach(p => {
    document.getElementById('modal-' + p).value = row[p] !== undefined ? row[p] : '';
    syncSignBtn('modal-' + p, 'modal-sign-' + p);
  });

  PLAYERS.forEach(p => { const b = document.getElementById('modal-sign-' + p); if(b) b.classList.remove('negative'); });
  document.getElementById('modal-status').textContent = '';
  document.getElementById('modal-status').className = 'modal-status';
  document.getElementById('modal-save').disabled = false;
  document.getElementById('modal-delete').disabled = false;
  document.getElementById('modal-overlay').classList.add('open');
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
  editingRow = null;
}

function handleOverlayClick(e) {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
}

async function saveEdit() {
  if (!editingRow) return;
  const saveBtn   = document.getElementById('modal-save');
  const deleteBtn = document.getElementById('modal-delete');
  const statusEl  = document.getElementById('modal-status');

  const dateVal = document.getElementById('modal-date').value; // YYYY-MM-DD
  const scores = {};
  PLAYERS.forEach(p => {
    const raw = document.getElementById('modal-' + p).value;
    scores[p] = raw === '' ? 0 : parseFloat(raw);
  });

  saveBtn.disabled = true;
  deleteBtn.disabled = true;
  statusEl.className = 'modal-status';
  statusEl.textContent = 'Saving‚Ä¶';

  try {
    await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'updateScore', rowIndex: editingRow.rowIndex, date: dateVal, scores }),
      headers: { 'Content-Type': 'text/plain' }
    });
    statusEl.className = 'modal-status ok';
    statusEl.textContent = '‚úì Saved!';
    setTimeout(closeModal, 800);
    await loadData();
  } catch(e) {
    statusEl.className = 'modal-status err';
    statusEl.textContent = '‚úó Save failed. Try again.';
    saveBtn.disabled = false;
    deleteBtn.disabled = false;
  }
}

async function confirmDelete() {
  if (!editingRow) return;
  const confirmed = window.confirm(`Delete Game #${editingRow.gameNum}? This cannot be undone.`);
  if (!confirmed) return;

  const saveBtn   = document.getElementById('modal-save');
  const deleteBtn = document.getElementById('modal-delete');
  const statusEl  = document.getElementById('modal-status');

  saveBtn.disabled = true;
  deleteBtn.disabled = true;
  statusEl.className = 'modal-status';
  statusEl.textContent = 'Deleting‚Ä¶';

  try {
    await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'deleteScore', rowIndex: editingRow.rowIndex }),
      headers: { 'Content-Type': 'text/plain' }
    });
    setTimeout(closeModal, 400);
    await loadData();
  } catch(e) {
    statusEl.className = 'modal-status err';
    statusEl.textContent = '‚úó Delete failed. Try again.';
    saveBtn.disabled = false;
    deleteBtn.disabled = false;
  }
}

// ‚îÄ‚îÄ‚îÄ ADD SCORE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function submitScore() {
  const btn = document.getElementById('submit-btn');
  const status = document.getElementById('status');
  const scores = {};
  PLAYERS.forEach(p => {
    const raw = document.getElementById('score-' + p).value;
    scores[p] = raw === '' ? 0 : parseFloat(raw);
  });

  const today = new Date().toISOString().slice(0, 10);
  btn.disabled = true;
  status.className = 'status-msg';
  status.textContent = 'Saving‚Ä¶';

  try {
    await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'addScore', date: today, scores }),
      headers: { 'Content-Type': 'text/plain' }
    });
    PLAYERS.forEach(p => { document.getElementById('score-' + p).value = ''; document.getElementById('sign-' + p).classList.remove('negative'); });
    status.className = 'status-msg ok';
    status.textContent = '‚úì Saved!';
    await loadData();
  } catch(e) {
    status.className = 'status-msg err';
    status.textContent = '‚úó Save failed. Try again.';
  }

  btn.disabled = false;
  setTimeout(() => status.textContent = '', 4000);
}


function toggleSign(inputId, btnId) {
  const input = document.getElementById(inputId);
  const btn   = document.getElementById(btnId);
  const val   = input.value.trim();

  if (val === '' || val === '0') return; // nothing to negate

  if (val.startsWith('-')) {
    input.value = val.slice(1);
    btn.classList.remove('negative');
  } else {
    input.value = '-' + val;
    btn.classList.add('negative');
  }
}

// Keep sign button state in sync when user types manually
function syncSignBtn(inputId, btnId) {
  const input = document.getElementById(inputId);
  const btn   = document.getElementById(btnId);
  if (input.value.trim().startsWith('-')) {
    btn.classList.add('negative');
  } else {
    btn.classList.remove('negative');
  }
}

loadData();
</script>
</body>
</html>
